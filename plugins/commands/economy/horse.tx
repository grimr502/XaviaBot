// Import the required modules
import axios from 'axios';

// Configuration for the horse racing game
const config = {
  name: "horse-racing",
  aliases: ["hr"],
  description: "Play horse racing with multiplayer.",
  usage: "Use it then you'll know.",
  cooldown: 3,
  permissions: [0, 1, 2],
  isAbsolute: false,
  isHidden: false,
  credits: "Dymyrius",
};

// Access the global API object
const { api } = global;

// Define the horseImages array outside the onCall function
const horseImages = [
  // URLs of horse images
  // Add or modify horse images as needed
  { number: 1, url: "https://i.imgur.com/I7ZElJ0.png" },
  { number: 2, url: "https://i.imgur.com/cRBu7li.png" },
  { number: 3, url: "https://i.imgur.com/SOaK0P6.png" },
  { number: 4, url: "https://i.imgur.com/NjiaX1B.png" },
  { number: 5, url: "https://i.imgur.com/ZY4m1zd.png" },
  { number: 6, url: "https://i.imgur.com/5F6VC3q.png" },
  { number: 7, url: "https://i.imgur.com/Ff5w1Me.png" },
  { number: 8, url: "https://i.imgur.com/DhEzQp9.png" },
  { number: 9, url: "https://i.imgur.com/F29yd5M.png" },
];

async function startRacingGame(threadID, bcl) {
  const horseRaceGif = (await axios.get("https://i.imgur.com/mHdw73G.png", {
    responseType: "stream",
  })).data;

  // Get the number of horses available based on the number of players who joined
  const numberOfPlayers = bcl.players.length;
  const horsesAvailable = Array.from({ length: numberOfPlayers }, (_, index) => index + 1).join(", ");

  api.sendMessage({
    body: `ã€˜ğ—›ğ—¢ğ—¥ğ—¦ğ—˜ğ—¦ ğ—šğ—˜ğ—§ğ—§ğ—œğ—¡ğ—š ğ—¥ğ—˜ğ—”ğ——ğ—œğ—¡ğ—šã€™\n\nPlease pick a horse number from 1 to 9 by typing the command \`!hr <horse_number>\`.\nğ—›ğ—¼ğ—¿ğ˜€ğ—²ğ˜€ ğ—”ğ˜ƒğ—®ğ—¶ğ—¹ğ—®ğ—¯ğ—¹ğ—²: ${horsesAvailable}`,
    attachment: horseRaceGif,
  }, threadID);

  // Unsend the racing animation and message after 8 seconds
  setTimeout(async () => {
    try {
      const messages = await api.getThreadMessages(threadID);
      const racingMessage = messages.find((msg) => msg.body === message);
      if (racingMessage) {
        await api.unsendMessage(racingMessage.messageID);
      }
    } catch (error) {
      console.error("ğ™´ğš›ğš›ğš˜ğš› ğš˜ğšŒğšŒğšğš›ğš›ğšğš ğš ğš‘ğš’ğš•ğš ğšğš—ğšœğšğš—ğšğš’ğš—ğš ğšğš‘ğš ğš›ğšŠğšŒğš’ğš—ğš ğš–ğšğšœğšœğšŠğšğš:", error.message);
    }
  }, 8000); // 8 seconds
}



// Main function to handle commands
async function onCall({ message, args }) {
  const { Users } = global.controllers;
  global.chanle || (global.chanle = new Map);
  var bcl = global.chanle.get(message.threadID);
  const horseImg = (await axios.get("https://i.imgur.com/lDiULBt.jpg", {
    responseType: "stream"
  })).data;
  const horseCrush = (await axios.get("https://i.imgur.com/thQbSER.gif", {
    responseType: "stream"
  })).data;
  const { senderID, threadID, messageID, body } = message;

  // ... (previous code remains the same)

  // Function to display the horse racing GIF and results
  async function displayRaceResults(threadID, bcl, winningHorseNumber, winner) {
    const horseRaceGif = (await axios.get("https://i.imgur.com/zIKiq8B.gif", {
      responseType: "stream",
    })).data;

    api.sendMessage({
      body: "ğ—¥ğ—®ğ—°ğ—¶ğ—»ğ—´...",
      attachment: horseRaceGif,
    }, threadID, async (err, racingMessage) => {
      if (err) {
        console.error("ğ™´ğš›ğš›ğš˜ğš› ğš˜ğšŒğšŒğšğš›ğš›ğšğš ğš ğš‘ğš’ğš•ğš ğšœğšğš—ğšğš’ğš—ğš ğšğš‘ğš ğš›ğšŠğšŒğš’ğš—ğš ğš–ğšğšœğšœğšŠğšğš:", err);
      } else {
        setTimeout(async () => {
          if (racingMessage) {
            await api.unsendMessage(racingMessage.messageID);
          }

          const horseNumber = (await axios.get(horseImages.find(horse => horse.number === winningHorseNumber).url, {
            responseType: "stream",
          })).data;

          const raceResult = `[ğŸ´] Â» ğšƒğš‘ğš ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš‘ğšŠğšœ ğšğš—ğšğšğš!\n\nğšƒğš‘ğš ğš ğš’ğš—ğš—ğš’ğš—ğš ğš‘ğš˜ğš›ğšœğš ğš’ğšœ ğš—ğšğš–ğš‹ğšğš› â¾${winningHorseNumber}âŒ!\n\nğšƒğš‘ğš ğš ğš’ğš—ğš—ğšğš› ğš’ğšœ ${winner.name}!\n\nğ‚ğ¨ğ§ğ ğ«ğšğ­ğ®ğ¥ğšğ­ğ¢ğ¨ğ§ğ¬! ğŸ‰ğŸ†`;

          api.sendMessage({
            body: raceResult,
            attachment: horseNumber,
          }, threadID);
        }, 8000); // 8 seconds delay before unsending the racing message
      }
    });
  }

  // Function to handle horse selection
  async function handleHorseSelection(threadID, bcl, senderID, horseNumber) {
    const player = bcl.players.find((p) => p.userID === senderID);
    if (!player) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšˆğš˜ğš ğš‘ğšŠğšŸğšğš—'ğš ğš“ğš˜ğš’ğš—ğšğš ğšğš‘ğš’ğšœ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš!", threadID, messageID);
    }
    if (player.horse !== null) {
      return api.sendMessage(`[ğŸ´ âš ] Â» ${player.name}, ğš¢ğš˜ğš ğš‘ğšŠğšŸğš ğšŠğš•ğš›ğšğšŠğšğš¢ ğš™ğš’ğšŒğš”ğšğš ğš‘ğš˜ğš›ğšœğš ğš—ğšğš–ğš‹ğšğš› ${player.horse}!`, threadID, messageID);
    }
    if (isNaN(horseNumber) || horseNumber < 1 || horseNumber > bcl.horses.length) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğ™¿ğš•ğšğšŠğšœğš ğšŒğš‘ğš˜ğš˜ğšœğš ğšŠ ğšŸğšŠğš•ğš’ğš ğš‘ğš˜ğš›ğšœğš ğš—ğšğš–ğš‹ğšğš›.", threadID, messageID);
    }
    if (bcl.players.some((p) => p.horse === horseNumber)) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğ™°ğš—ğš˜ğšğš‘ğšğš› ğš™ğš•ğšŠğš¢ğšğš› ğš‘ğšŠğšœ ğšŠğš•ğš›ğšğšŠğšğš¢ ğš™ğš’ğšŒğš”ğšğš ğšğš‘ğš’ğšœ ğš‘ğš˜ğš›ğšœğš ğš—ğšğš–ğš‹ğšğš›! ğ™¿ğš•ğšğšŠğšœğš ğšŒğš‘ğš˜ğš˜ğšœğš ğšŠğš—ğš˜ğšğš‘ğšğš› ğš˜ğš—ğš.", threadID, messageID);
    }
    player.horse = horseNumber;
    global.chanle.set(threadID, bcl);
    const playerName = player.name || senderID;
    api.sendMessage(`[ğŸ´] Â» ${playerName} ğš™ğš’ğšŒğš”ğšğš ğš‘ğš˜ğš›ğšœğš ğš—ğšğš–ğš‹ğšğš› ${player.horse}.`, threadID, messageID);

    // Check if all players have made their choices
    const allPlayersChosen = bcl.players.every((p) => p.horse !== null);
    if (allPlayersChosen) {
      // All players have made their choices, start the race!
      const winningHorseNumber = Math.floor(Math.random() * bcl.horses.length) + 1; // Generate a random horse number between 1 and number of horses
      const winner = bcl.players.find((p) => p.horse === winningHorseNumber);
      if (winner) {
        const playerName = winner.name || senderID;
        const betAmount = bcl.reservationAmount;
        const totalPlayers = bcl.players.length;

        // Calculate the payout for each winner
        const payout = betAmount * (totalPlayers - 1);

        // Increase the money for the winner(s)
        await Users.increaseMoney(winner.userID, payout);

        // Decrease the money for the losers
        for (const player of bcl.players) {
          if (player.userID !== winner.userID) {
            await Users.decreaseMoney(player.userID, betAmount);
          }
        }

        displayRaceResults(threadID, bcl, winningHorseNumber, winner);
      } else {
        api.sendMessage("[SIES-NOTI] Â» The horse racing game has ended!\n\nUnfortunately, there is no winner this time. Better luck next time!", threadID);
      }

      // Reset the game state
      global.chanle.delete(threadID);
    }
  }

  if (args[0] === "create" || args[0] === "new" || args[0] === "-c") {
    // Create a new horse racing game
    if (!args[1] || isNaN(args[1])) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšˆğš˜ğš ğš—ğšğšğš ğšğš˜ ğšğš—ğšğšğš› ğšŠ ğš›ğšğšœğšğš›ğšŸğšŠğšğš’ğš˜ğš— ğšŠğš–ğš˜ğšğš—ğš!", threadID, messageID);
    }
    const reservationAmount = parseInt(args[1]);
    if (reservationAmount < 500) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğ™°ğš–ğš˜ğšğš—ğš ğš–ğšğšœğš ğš‹ğš ğšğš›ğšğšŠğšğšğš› ğšğš‘ğšŠğš— ğš˜ğš› ğšğššğšğšŠğš• ğšğš˜ ğŸ»ğŸ¶ğŸ¶!", threadID, messageID);
    }
    const userMoney = await Users.getMoney(senderID) || null;
    if (userMoney < reservationAmount) {
      return api.sendMessage(`[ğŸ´ âš ] Â» ğšˆğš˜ğš ğšğš˜ğš—'ğš ğš‘ğšŠğšŸğš ğšğš—ğš˜ğšğšğš‘ ${reservationAmount}$ ğšğš˜ ğšŒğš›ğšğšŠğšğš ğšŠ ğš—ğšğš  ğšğšŠğš–ğš!`, threadID, messageID);
    }
    if (global.chanle.has(threadID)) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğš’ğšœ ğšğš›ğš˜ğšğš™ ğš‘ğšŠğšœ ğšŠğš•ğš›ğšğšŠğšğš¢ ğš˜ğš™ğšğš—ğšğš ğšŠ ğšğšŠğš–ğš ğšğšŠğš‹ğš•ğš!", threadID, messageID);
    }

    const playerName = (await global.controllers.Users.getInfo(senderID))?.name || senderID;
    global.chanle.set(threadID, {
      box: threadID,
      start: false,
      author: senderID,
      players: [{
        name: playerName,
        userID: senderID,
        horse: null,
      }],
      reservationAmount: reservationAmount,
    });
    return api.sendMessage(`[ğŸ´] Â» ğš‚ğšğšŒğšŒğšğšœğšœğšğšğš•ğš•ğš¢ ğšŒğš›ğšğšŠğšğšğš ğšŠ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš ğš’ğšğš‘ ğšŠ ğš›ğšğšœğšğš›ğšŸğšŠğšğš’ğš˜ğš— ğšŠğš–ğš˜ğšğš—ğš ğš˜ğš ${reservationAmount}$.`, threadID);

  } else if (args[0] === "join" || args[0] === "-j") {
    // Join the horse racing game
    if (!global.chanle.has(threadID)) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğšğš›ğš ğš’ğšœ ğšŒğšğš›ğš›ğšğš—ğšğš•ğš¢ ğš—ğš˜ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš’ğš— ğšğš‘ğš’ğšœ ğšğš›ğš˜ğšğš™!\n=> ğ™¿ğš•ğšğšŠğšœğš ğšŒğš›ğšğšŠğšğš ğšŠ ğš—ğšğš  ğšğšŠğš–ğš ğšğš˜ ğš“ğš˜ğš’ğš—!", threadID, messageID);
    }
    bcl = global.chanle.get(threadID);
    if (bcl.start) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğš’ğšœ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš‘ğšŠğšœ ğšŠğš•ğš›ğšğšŠğšğš¢ ğšœğšğšŠğš›ğšğšğš!", threadID, messageID);
    }
    const reservationAmount = bcl.reservationAmount;
    const playerMoney = await Users.getMoney(senderID) || null;
    if (playerMoney < reservationAmount) {
      return api.sendMessage(`[ğŸ´ âš ] Â» ğšˆğš˜ğš ğšğš˜ğš—'ğš ğš‘ğšŠğšŸğš ğšğš—ğš˜ğšğšğš‘ ${reservationAmount}$ ğšğš˜ ğš“ğš˜ğš’ğš— ğšğš‘ğš’ğšœ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš!`, threadID, messageID);
    }
    const playerName = (await global.controllers.Users.getInfo(senderID))?.name || senderID;
    if (bcl.players.find((player) => player.userID === senderID)) {
      return api.sendMessage("ğšˆğš˜ğš ğš‘ğšŠğšŸğš ğšŠğš•ğš›ğšğšŠğšğš¢ ğš“ğš˜ğš’ğš—ğšğš ğšğš‘ğš’ğšœ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš!", threadID, messageID);
    }
    bcl.players.push({
      name: playerName,
      userID: senderID,
      horse: null,
    });
    global.chanle.set(threadID, bcl);
    return api.sendMessage(`[ğŸ´] Â» ğšˆğš˜ğš ğš‘ğšŠğšŸğš ğš“ğš˜ğš’ğš—ğšğš ğšğš‘ğš ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš!\n=> ğšƒğš‘ğš ğšŒğšğš›ğš›ğšğš—ğš ğš—ğšğš–ğš‹ğšğš› ğš˜ğš ğš™ğš•ğšŠğš¢ğšğš›ğšœ ğš’ğšœ: ${bcl.players.length}`, threadID, messageID);

  } else if (args[0] === "start" || args[0] === "-s") {
    // Start the horse racing game
    bcl = global.chanle.get(threadID);
    if (!bcl) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğšğš›ğš ğš’ğšœ ğšŒğšğš›ğš›ğšğš—ğšğš•ğš¢ ğš—ğš˜ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš’ğš— ğšğš‘ğš’ğšœ ğšğš›ğš˜ğšğš™!\n=> ğ™¿ğš•ğšğšŠğšœğš ğšŒğš›ğšğšŠğšğš ğšŠ ğš—ğšğš  ğšğšŠğš–ğš ğšğš˜ ğš“ğš˜ğš’ğš—!", threadID, messageID);
    }
    if (bcl.author !== senderID) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšˆğš˜ğš ğšŠğš›ğš ğš—ğš˜ğš ğšğš‘ğš ğšŒğš›ğšğšŠğšğš˜ğš› ğš˜ğš ğšğš‘ğš’ğšœ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš, ğšœğš˜ ğš¢ğš˜ğš ğšŒğšŠğš—ğš—ğš˜ğš ğšœğšğšŠğš›ğš ğšğš‘ğš ğšğšŠğš–ğš.", threadID, messageID);
    }
    if (bcl.players.length < 2) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšˆğš˜ğšğš› ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğšğš˜ğšğšœğš—'ğš ğš‘ğšŠğšŸğš ğšğš—ğš˜ğšğšğš‘ ğš™ğš•ğšŠğš¢ğšğš›ğšœ ğšğš˜ ğšœğšğšŠğš›ğš!", threadID, messageID);
    }
    if (bcl.start) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğš’ğšœ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš‘ğšŠğšœ ğšŠğš•ğš›ğšğšŠğšğš¢ ğšœğšğšŠğš›ğšğšğš!", threadID, messageID);
    }

    bcl.start = true;
    // Set the number of horses based on the number of players
    const numberOfPlayers = bcl.players.length;
    bcl.horses = Array.from({ length: numberOfPlayers }, (_, index) => index + 1);
    // Shuffle the horses randomly
    bcl.horses.sort(() => Math.random() - 0.5);
    global.chanle.set(threadID, bcl);

    // Start the race with the new number of horses
    startRacingGame(threadID, bcl);

  } else if (!isNaN(args[0])) {
    // Player picks a horse number
    bcl = global.chanle.get(threadID);
    if (!bcl) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğšğš›ğš ğš’ğšœ ğšŒğšğš›ğš›ğšğš—ğšğš•ğš¢ ğš—ğš˜ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš’ğš— ğšğš‘ğš’ğšœ ğšğš›ğš˜ğšğš™!\n=> ğ™¿ğš•ğšğšŠğšœğš ğšŒğš›ğšğšŠğšğš ğšŠ ğš—ğšğš  ğšğšŠğš–ğš ğšğš˜ ğš“ğš˜ğš’ğš—!", threadID, messageID);
    }
    if (!bcl.start) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğš ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš‘ğšŠğšœ ğš—ğš˜ğš ğšœğšğšŠğš›ğšğšğš ğš¢ğšğš!", threadID, messageID);
    }

    const horseNumber = parseInt(args[0]);
    handleHorseSelection(threadID, bcl, senderID, horseNumber);
  } else if (args[0] === "end" || args[0] === "-e") {
    // End the horse racing game and delete it if the creator uses this command
    bcl = global.chanle.get(threadID);
    if (!bcl) {
      return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğšğš›ğš ğš’ğšœ ğšŒğšğš›ğš›ğšğš—ğšğš•ğš¢ ğš—ğš˜ ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš’ğš— ğšğš‘ğš’ğšœ ğšğš›ğš˜ğšğš™!\n=> ğ™¿ğš•ğšğšŠğšœğš ğšŒğš›ğšğšŠğšğš ğšŠ ğš—ğšğš  ğšğšŠğš–ğš ğšğš˜ ğš“ğš˜ğš’ğš—!", threadID, messageID);
    }

    const isCreator = bcl.author === senderID;
    if (isCreator) {
      // The game creator uses the command, delete the game
      global.chanle.delete(threadID);
      return api.sendMessage("[ğŸ´] Â» ğšƒğš‘ğš ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš‘ğšŠğšœ ğš‹ğšğšğš— ğšğšğš•ğšğšğšğš ğš‹ğš¢ ğšğš‘ğš ğšŒğš›ğšğšŠğšğš˜ğš›.", threadID, messageID);
    } else {
      // Another player uses the command, determine the winner and show the results
      if (!bcl.start) {
        return api.sendMessage("[ğŸ´ âš ] Â» ğšƒğš‘ğš ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš‘ğšŠğšœ ğš—ğš˜ğš ğšœğšğšŠğš›ğšğšğš ğš¢ğšğš!", threadID, messageID);
      }

      const numberOfPlayers = bcl.players.length;
      let winner = null;
      const winningHorseNumber = Math.floor(Math.random() * bcl.horses.length) + 1; // Generate a random horse number between 1 and number of horses
      for (let i = 0; i < numberOfPlayers; i++) {
        const player = bcl.players[i];
        if (player.horse === winningHorseNumber) {
          winner = player;
          break;
        }
      }
      if (winner) {
        const playerName = winner.name || senderID;
        displayRaceResults(threadID, bcl, winningHorseNumber, winner);
      } else {
        api.sendMessage({
          body: "[ğŸ´] Â» ğšƒğš‘ğš ğš‘ğš˜ğš›ğšœğš ğš›ğšŠğšŒğš’ğš—ğš ğšğšŠğš–ğš ğš‘ğšŠğšœ ğšğš—ğšğšğš!\n\nğš„ğš—ğšğš˜ğš›ğšğšğš—ğšŠğšğšğš•ğš¢, ğšğš‘ğšğš›ğš ğš’ğšœ ğš—ğš˜ ğš ğš’ğš—ğš—ğšğš› ğšğš‘ğš’ğšœ ğšğš’ğš–ğš. ğ™±ğšğšğšğšğš› ğš•ğšğšŒğš” ğš—ğšğš¡ğš ğšğš’ğš–ğš!",
          attachment: horseCrush
        }, threadID);
      }

      // Reset the game state
      global.chanle.delete(threadID);
    }
  } else {
    // Display help information if the command is not recognized
    return api.sendMessage({
      body: "=ã€ğŒğ®ğ¥ğ­ğ¢ğ©ğ¥ğšğ²ğğ« ğ‡ğ¨ğ«ğ¬ğ ğ‘ğšğœğ¢ğ§ğ  ğ†ğšğ¦ğã€‘=\n1. !hr -c/create <price> => Create a new horse racing game.\n2. !hr -j/join => Join to enter the game.\n3. !hr -s/start => Start the game.\n4. !hr <horse_number> => Pick a horse number (1 to 9).\n5. !hr -e/end => End the game (for players) or delete the game (for the creator).",
      attachment: horseImg,
    }, threadID, messageID);
  }
}

// Export the configuration and the main function
export default {
  config,
  onCall,
};